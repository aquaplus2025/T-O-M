<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOM - Timesheet</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f0f0f0;
            color: #333;
            font-size: 13px;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .user-name input {
            border: 1px solid #ccc;
            padding: 4px 8px;
            font-size: 13px;
            width: 140px;
        }

        .lang-selector {
            display: flex;
            gap: 2px;
        }

        .lang-btn {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 11px;
        }

        .lang-btn:hover {
            background: #f0f0f0;
        }

        .lang-btn.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn:hover {
            background: #f0f0f0;
        }

        .btn-primary {
            background: #4a4;
            color: #fff;
            border-color: #4a4;
        }

        .btn-primary:hover {
            background: #393;
        }

        .btn-excel {
            background: #217346;
            color: #fff;
            border-color: #217346;
        }

        .btn-excel:hover {
            background: #1a5c38;
        }

        .btn-csv {
            background: #0066cc;
            color: #fff;
            border-color: #0066cc;
        }

        .btn-csv:hover {
            background: #0052a3;
        }

        .btn-import {
            background: #9c27b0;
            color: #fff;
            border-color: #9c27b0;
        }

        .btn-import:hover {
            background: #7b1fa2;
        }

        .btn-github {
            background: #24292e;
            color: #fff;
            border-color: #24292e;
        }

        .btn-github:hover {
            background: #1b1f23;
        }

        .btn-overview {
            background: #ff9800;
            color: #fff;
            border-color: #ff9800;
        }

        .btn-overview:hover {
            background: #f57c00;
        }

        .btn-share {
            background: #1877f2;
            color: #fff;
            border-color: #1877f2;
        }

        .btn-share:hover {
            background: #1565c0;
        }

        .btn-email {
            background: #ea4335;
            color: #fff;
            border-color: #ea4335;
        }

        .btn-email:hover {
            background: #c5221f;
        }

        .btn-help {
            background: #666;
            color: #fff;
            border-color: #666;
            font-weight: bold;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            justify-content: center;
            padding: 0;
        }

        .btn-help:hover {
            background: #555;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .view-selector {
            display: flex;
            gap: 4px;
        }

        .view-btn {
            padding: 5px 12px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
        }

        .view-btn:hover {
            background: #f0f0f0;
        }

        .view-btn.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        .period-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .period-nav button {
            padding: 4px 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }

        .period-nav button:hover {
            background: #f0f0f0;
        }

        .period-label {
            min-width: 160px;
            text-align: center;
            font-weight: bold;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            gap: 10px;
            min-height: 0;
            overflow: hidden;
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        .right-panel {
            width: 200px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        /* Summary Cards */
        .summary-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }

        .summary-card {
            flex: 1;
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }

        .summary-card .value {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .summary-card .label {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
            text-transform: uppercase;
        }

        .summary-card.overtime .value {
            color: #c44;
        }

        .summary-card.overtime.positive .value {
            color: #4a4;
        }

        /* Timesheet Grid */
        .timesheet-wrapper {
            flex: 1;
            background: #fff;
            border: 1px solid #ccc;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .timesheet {
            flex: 1;
            overflow: auto;
        }

        .timesheet table {
            border-collapse: collapse;
            width: max-content;
            min-width: 100%;
        }

        .timesheet th,
        .timesheet td {
            border: 1px solid #ddd;
            padding: 5px 6px;
            text-align: center;
            white-space: nowrap;
        }

        .timesheet thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timesheet th {
            background: #f5f5f5;
            font-weight: 500;
            font-size: 13px;
        }

        .timesheet th.project-header {
            min-width: 65px;
            max-width: 85px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timesheet td.date-cell {
            text-align: left;
            background: #fafafa;
            font-weight: 500;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 80px;
        }

        .timesheet thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 15;
        }

        .timesheet td.weekend {
            background: #f0f0f0;
        }

        .timesheet td.weekend.date-cell {
            background: #e8e8e8;
        }

        .timesheet td.holiday {
            background: #ffe0e0;
        }

        .timesheet td.holiday.date-cell {
            background: #ffcccc;
        }

        .timesheet td.today {
            background: #fffde7;
        }

        .timesheet td.today.date-cell {
            background: #fff9c4;
        }

        .timesheet input[type="number"] {
            width: 42px;
            padding: 3px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 12px;
        }

        .timesheet input[type="number"]:focus {
            outline: none;
            border-color: #4a4;
        }

        .timesheet select {
            padding: 3px;
            border: 1px solid #ddd;
            font-size: 11px;
            width: 85px;
        }

        .timesheet input[type="text"] {
            width: 100px;
            padding: 3px;
            border: 1px solid #ddd;
            font-size: 11px;
        }

        .timesheet .duration-cell {
            font-weight: bold;
            background: #f9f9f9;
            min-width: 55px;
        }

        .timesheet .overtime-cell {
            color: #c44;
            background: #fff5f5;
            min-width: 55px;
        }

        .timesheet .overtime-cell.positive {
            color: #4a4;
            background: #f5fff5;
        }

        .timesheet tfoot {
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .timesheet tfoot td {
            background: #e8e8e8;
            font-weight: bold;
        }

        .timesheet tfoot td:first-child {
            position: sticky;
            left: 0;
            z-index: 15;
        }

        /* Holiday Panel */
        .holiday-panel {
            background: #fff;
            border: 1px solid #ccc;
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .holiday-panel h3 {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            flex-shrink: 0;
        }

        .holiday-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .holiday-item {
            padding: 8px 10px;
            border-left: 3px solid #c44;
            background: #fff5f5;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .holiday-item .holiday-date {
            font-weight: bold;
            color: #333;
        }

        .holiday-item .holiday-name {
            color: #666;
            margin-top: 2px;
        }

        .holiday-item.past {
            opacity: 0.5;
            border-left-color: #999;
            background: #f5f5f5;
        }

        .no-holidays {
            color: #888;
            text-align: center;
            padding: 20px 10px;
            font-size: 12px;
        }

        /* Project Management */
        .project-manager {
            background: #fff;
            border: 1px solid #ccc;
            padding: 10px 12px;
            margin-top: 10px;
            flex-shrink: 0;
        }

        .project-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .project-manager h3 {
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
        }

        .project-add {
            display: flex;
            gap: 8px;
        }

        .project-add select {
            padding: 4px 8px;
            border: 1px solid #ccc;
            font-size: 12px;
        }

        .project-add input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            font-size: 12px;
            width: 150px;
        }

        .project-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .project-tag {
            background: #e8e8e8;
            padding: 3px 8px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .project-tag .remove {
            color: #c44;
            cursor: pointer;
            font-weight: bold;
        }

        /* Status */
        .status-msg {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: #dfd;
            color: #363;
            font-size: 13px;
            display: none;
            z-index: 100;
            border: 1px solid #afa;
        }

        /* Scroll hint */
        .scroll-hint {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: #fff;
            padding: 5px 10px;
            font-size: 11px;
            border-radius: 3px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .timesheet-wrapper:hover .scroll-hint.show {
            opacity: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 8px;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 90%;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f5f5f5;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: bold;
        }

        .modal-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-body h3 {
            font-size: 14px;
            margin: 15px 0 8px 0;
            color: #333;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body p, .modal-body li {
            font-size: 13px;
            line-height: 1.6;
            color: #555;
        }

        .modal-body ul {
            margin-left: 20px;
        }

        .modal-body li {
            margin-bottom: 5px;
        }

        .modal-body .shortcut {
            display: inline-block;
            background: #e8e8e8;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        /* Project Overview Table */
        .overview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .overview-table th,
        .overview-table td {
            border: 1px solid #ddd;
            padding: 10px 12px;
            text-align: left;
        }

        .overview-table th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .overview-table tr:nth-child(even) {
            background: #fafafa;
        }

        .overview-table tfoot td {
            background: #e8e8e8;
            font-weight: bold;
        }

        .overview-table .hours-cell {
            text-align: right;
            font-weight: 500;
        }

        .overview-table .percent-cell {
            text-align: right;
            color: #666;
        }

        .overview-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .overview-stat {
            background: #f5f5f5;
            padding: 15px;
            text-align: center;
            border-radius: 4px;
        }

        .overview-stat .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .overview-stat .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }

        /* Print styles */
        @media print {
            @page {
                size: A4 landscape;
                margin: 15mm;
            }

            html, body {
                overflow: visible;
                height: auto;
            }

            body {
                font-size: 11px;
                background: #fff;
            }

            .container {
                overflow: visible;
                padding: 0;
            }

            .header-actions, .project-manager, .controls .view-selector, .lang-selector, .right-panel, .btn {
                display: none !important;
            }

            .header {
                border: none;
                margin-bottom: 5mm;
            }

            .controls {
                border: none;
                margin-bottom: 3mm;
            }

            .summary-row {
                margin-bottom: 5mm;
            }

            .summary-card {
                border: 1px solid #333;
            }

            .main-content {
                display: block;
                overflow: visible;
            }

            .left-panel {
                width: 100%;
                overflow: visible;
            }

            .timesheet-wrapper {
                overflow: visible;
                border: 2px solid #333;
            }

            .timesheet {
                overflow: visible;
            }

            .timesheet table {
                width: 100%;
                table-layout: auto;
            }

            .timesheet thead {
                display: table-header-group;
            }

            .timesheet tbody {
                display: table-row-group;
            }

            .timesheet tfoot {
                display: table-footer-group;
                position: relative;
            }

            .timesheet tfoot td {
                border-top: 2px solid #333;
            }

            .timesheet th,
            .timesheet td {
                border: 1px solid #333;
                padding: 3px 4px;
                font-size: 10px;
                position: static !important;
            }

            .timesheet input,
            .timesheet select {
                border: none;
                background: transparent;
                font-size: 10px;
                padding: 0;
                text-align: center;
            }

            .modal-overlay {
                display: none !important;
            }

            /* Overview print styles */
            .overview-table {
                page-break-inside: avoid;
            }

            .overview-table th,
            .overview-table td {
                border: 1px solid #333;
                padding: 6px 8px;
            }
        }

        /* Print for overview modal */
        @media print {
            .modal-overlay.show.print-mode {
                display: block !important;
                position: static;
                background: none;
            }

            .modal-overlay.show.print-mode .modal {
                box-shadow: none;
                border-radius: 0;
                max-width: 100%;
                max-height: none;
            }

            .modal-overlay.show.print-mode .modal-close {
                display: none;
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .right-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="user-name">
                    <span data-i18n="name">Name:</span>
                    <input type="text" id="userName" data-i18n-placeholder="yourName" placeholder="Your Name" onchange="saveSettings()">
                </div>
                <div class="lang-selector">
                    <button class="lang-btn active" data-lang="en">EN</button>
                    <button class="lang-btn" data-lang="de">DE</button>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-overview" onclick="showProjectOverview()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4 14h-2v-4H9v4H7v-6h2v2h4v-2h2v6zm0-8H9V7h6v2z"/></svg>
                    <span data-i18n="projectOverview">Projekt Übersicht</span>
                </button>
                <button class="btn btn-github" onclick="showGitHubModal()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                    <span data-i18n="loadGitHub">Load GitHub</span>
                </button>
                <button class="btn btn-import" onclick="document.getElementById('csvImport').click()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                    <span data-i18n="importCSV">Import CSV</span>
                </button>
                <input type="file" id="csvImport" class="hidden-input" accept=".csv" onchange="importCSV(this)">
                <button class="btn btn-csv" onclick="exportCSV()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zm-8 2V5h2v6h1.17L12 13.17 9.83 11H11zm-6 7h14v2H5v-2z"/></svg>
                    <span data-i18n="exportCSV">Export CSV</span>
                </button>
                <button class="btn btn-share" onclick="shareSheet()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                    <span data-i18n="share">Share</span>
                </button>
                <button class="btn btn-email" onclick="emailSheet()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                    <span data-i18n="email">Email</span>
                </button>
                <button class="btn btn-excel" onclick="exportExcel()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/><path d="M8 12h3l1.5 2.5L14 12h3l-3 4.5 3 4.5h-3l-1.5-2.5L11 21H8l3-4.5z"/></svg>
                    <span data-i18n="exportExcel">Export Excel</span>
                </button>
                <button class="btn" onclick="printSheet()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
                    <span data-i18n="print">Print</span>
                </button>
                <button class="btn btn-help" onclick="showHelp()" title="Help">?</button>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="view-selector">
                <button class="view-btn" data-view="day" data-i18n="day">Day</button>
                <button class="view-btn" data-view="week" data-i18n="week">Week</button>
                <button class="view-btn active" data-view="month" data-i18n="month">Month</button>
                <button class="view-btn" data-view="year" data-i18n="year">Year</button>
            </div>
            <div class="period-nav">
                <button onclick="prevPeriod()">&larr;</button>
                <span class="period-label" id="periodLabel">January 2026</span>
                <button onclick="nextPeriod()">&rarr;</button>
            </div>
        </div>

        <!-- Summary -->
        <div class="summary-row">
            <div class="summary-card">
                <div class="value" id="totalHours">0:00</div>
                <div class="label" data-i18n="totalHours">Total Hours</div>
            </div>
            <div class="summary-card">
                <div class="value" id="targetHours">0:00</div>
                <div class="label" data-i18n="target">Target (8h/day)</div>
            </div>
            <div class="summary-card overtime" id="overtimeCard">
                <div class="value" id="overtimeHours">0:00</div>
                <div class="label" data-i18n="overtime">Overtime</div>
            </div>
            <div class="summary-card">
                <div class="value" id="workDays">0</div>
                <div class="label" data-i18n="workDays">Work Days</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left: Timesheet -->
            <div class="left-panel">
                <div class="timesheet-wrapper">
                    <div class="timesheet" id="timesheetScroll">
                        <table id="timesheetTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                            <tfoot id="tableFoot"></tfoot>
                        </table>
                    </div>
                    <div class="scroll-hint" id="scrollHint" data-i18n="scrollHint">Scroll →</div>
                </div>

                <!-- Project Manager -->
                <div class="project-manager">
                    <div class="project-manager-header">
                        <h3 data-i18n="projects">Projects</h3>
                        <div class="project-add">
                            <select id="addType">
                                <option value="project" data-i18n="project">Project</option>
                                <option value="location" data-i18n="locationOption">Arbeitsort</option>
                            </select>
                            <input type="text" id="newProject" data-i18n-placeholder="newEntry" placeholder="New entry" onkeypress="if(event.key==='Enter')addEntry()">
                            <button class="btn btn-primary" onclick="addEntry()">+ <span data-i18n="add">Add</span></button>
                        </div>
                    </div>
                    <div class="project-list" id="projectList"></div>
                </div>
            </div>

            <!-- Right: Holidays -->
            <div class="right-panel">
                <div class="holiday-panel">
                    <h3 data-i18n="holidays">Feiertage</h3>
                    <div class="holiday-list" id="holidayList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="helpTitle">TOM - User Guide</h2>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body" id="helpBody"></div>
        </div>
    </div>

    <!-- Project Overview Modal -->
    <div class="modal-overlay" id="overviewModal">
        <div class="modal">
            <div class="modal-header">
                <h2 data-i18n="projectOverview">Projekt Übersicht</h2>
                <div class="modal-header-actions">
                    <button class="btn btn-csv" onclick="exportOverviewCSV()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zm-8 2V5h2v6h1.17L12 13.17 9.83 11H11zm-6 7h14v2H5v-2z"/></svg>
                        <span data-i18n="exportCSV">Export CSV</span>
                    </button>
                    <button class="btn btn-excel" onclick="exportOverviewExcel()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/><path d="M8 12h3l1.5 2.5L14 12h3l-3 4.5 3 4.5h-3l-1.5-2.5L11 21H8l3-4.5z"/></svg>
                        <span data-i18n="exportExcel">Excel</span>
                    </button>
                    <button class="btn" onclick="printOverview()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
                        <span data-i18n="print">Print</span>
                    </button>
                    <button class="modal-close" onclick="closeOverview()">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="overviewBody"></div>
        </div>
    </div>

    <!-- GitHub Load Modal -->
    <div class="modal-overlay" id="githubModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 data-i18n="loadGitHub">Load from GitHub</h2>
                <button class="modal-close" onclick="closeGitHubModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p data-i18n="githubInstructions" style="margin-bottom: 15px;">Enter the raw GitHub URL of your CSV file. You can get this by clicking "Raw" on your CSV file in GitHub.</p>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;" data-i18n="githubUrl">GitHub Raw URL:</label>
                    <input type="text" id="githubUrl" style="width: 100%; padding: 8px; border: 1px solid #ccc; font-size: 13px;" placeholder="https://raw.githubusercontent.com/user/repo/main/data.csv">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="githubSaveUrl" checked>
                        <span data-i18n="saveUrlForFuture">Save URL for future use</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" onclick="closeGitHubModal()" data-i18n="cancel">Cancel</button>
                    <button class="btn btn-primary" onclick="loadFromGitHub()" data-i18n="load">Load</button>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 4px;">
                    <h4 style="margin-bottom: 10px; font-size: 13px;" data-i18n="howToUse">How to use:</h4>
                    <ol style="font-size: 12px; color: #666; margin-left: 20px; line-height: 1.8;">
                        <li data-i18n="step1">Export your data as CSV using "Export CSV"</li>
                        <li data-i18n="step2">Upload the CSV file to your GitHub repository</li>
                        <li data-i18n="step3">Click "Raw" button on the file page</li>
                        <li data-i18n="step4">Copy the URL and paste it here</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="status-msg" id="statusMsg"></div>

    <script>
        // German Holidays (National + Baden-Württemberg)
        function getEasterSunday(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month - 1, day);
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function getHolidaysForYear(year) {
            const easter = getEasterSunday(year);

            const holidays = [
                { date: new Date(year, 0, 1), de: 'Neujahr', en: 'New Year\'s Day' },
                { date: new Date(year, 0, 6), de: 'Heilige Drei Könige', en: 'Epiphany', bw: true },
                { date: new Date(year, 4, 1), de: 'Tag der Arbeit', en: 'Labour Day' },
                { date: new Date(year, 9, 3), de: 'Tag der Deutschen Einheit', en: 'German Unity Day' },
                { date: new Date(year, 10, 1), de: 'Allerheiligen', en: 'All Saints\' Day', bw: true },
                { date: new Date(year, 11, 25), de: '1. Weihnachtstag', en: 'Christmas Day' },
                { date: new Date(year, 11, 26), de: '2. Weihnachtstag', en: 'St. Stephen\'s Day' },
                { date: addDays(easter, -2), de: 'Karfreitag', en: 'Good Friday' },
                { date: addDays(easter, 1), de: 'Ostermontag', en: 'Easter Monday' },
                { date: addDays(easter, 39), de: 'Christi Himmelfahrt', en: 'Ascension Day' },
                { date: addDays(easter, 50), de: 'Pfingstmontag', en: 'Whit Monday' },
                { date: addDays(easter, 60), de: 'Fronleichnam', en: 'Corpus Christi', bw: true },
            ];

            return holidays.sort((a, b) => a.date - b.date);
        }

        function getHolidayMap(year) {
            const holidays = getHolidaysForYear(year);
            const map = {};
            holidays.forEach(h => {
                const key = formatDate(h.date);
                map[key] = h;
            });
            return map;
        }

        // Translations
        const translations = {
            en: {
                name: 'Name:',
                yourName: 'Your Name',
                share: 'Share',
                email: 'Email',
                exportExcel: 'Export Excel',
                exportCSV: 'Export CSV',
                importCSV: 'Import CSV',
                print: 'Print',
                day: 'Day',
                week: 'Week',
                month: 'Month',
                year: 'Year',
                totalHours: 'Total Hours',
                target: 'Target (8h/day)',
                overtime: 'Overtime',
                workDays: 'Work Days',
                projects: 'Projects',
                newProject: 'New project',
                newEntry: 'New entry',
                add: 'Add',
                project: 'Project',
                locationOption: 'Location',
                scrollHint: 'Scroll →',
                date: 'Date',
                duration: 'Duration',
                location: 'Location',
                notes: 'Notes',
                total: 'Total',
                office: 'Office',
                homeOffice: 'Home-office',
                onSite: 'On-site',
                vacation: 'Vacation',
                holiday: 'Holiday',
                projectExists: 'Project already exists',
                projectAdded: 'Project added',
                locationAdded: 'Location added',
                locationExists: 'Location already exists',
                removeProject: 'Remove project',
                excelExported: 'Excel exported',
                csvExported: 'CSV exported',
                csvImported: 'CSV imported',
                csvImportError: 'Error importing CSV',
                copiedClipboard: 'Copied to clipboard',
                couldNotShare: 'Could not share',
                timesheet: 'Timesheet',
                totalLabel: 'Total',
                byLabel: 'By',
                projectBreakdown: 'Project breakdown',
                helpTitle: 'TOM - User Guide',
                holidays: 'Holidays',
                noHolidays: 'No holidays in this period',
                projectOverview: 'Project Overview',
                hours: 'Hours',
                percentage: 'Percentage',
                averagePerDay: 'Average/Day',
                projectName: 'Project Name',
                loadGitHub: 'Load GitHub',
                githubInstructions: 'Enter the raw GitHub URL of your CSV file. You can get this by clicking "Raw" on your CSV file in GitHub.',
                githubUrl: 'GitHub Raw URL:',
                saveUrlForFuture: 'Save URL for future use',
                cancel: 'Cancel',
                load: 'Load',
                howToUse: 'How to use:',
                step1: 'Export your data as CSV using "Export CSV"',
                step2: 'Upload the CSV file to your GitHub repository',
                step3: 'Click "Raw" button on the file page',
                step4: 'Copy the URL and paste it here',
                githubLoaded: 'Data loaded from GitHub',
                githubError: 'Error loading from GitHub',
                githubNoUrl: 'Please enter a GitHub URL',
                days: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                helpContent: `
                    <h3>Getting Started</h3>
                    <p>TOM is a simple timesheet application to track your working hours by project. All data is stored locally in your browser.</p>

                    <h3>Enter Your Hours</h3>
                    <ul>
                        <li>Click on any cell in the grid to enter hours for that project/day</li>
                        <li>Use decimal values for partial hours (e.g., 0.5 for 30 minutes, 0.25 for 15 minutes)</li>
                        <li>Duration and overtime are calculated automatically</li>
                        <li>Select your work location from the dropdown</li>
                        <li>Add notes to describe your work</li>
                        <li>On holidays, the location is automatically set to "Holiday"</li>
                    </ul>

                    <h3>View Options</h3>
                    <ul>
                        <li><strong>Day</strong> - View a single day</li>
                        <li><strong>Week</strong> - View Monday to Sunday</li>
                        <li><strong>Month</strong> - View entire month (default)</li>
                        <li><strong>Year</strong> - View entire year</li>
                    </ul>
                    <p>Use the arrow buttons to navigate between periods.</p>

                    <h3>Holidays</h3>
                    <ul>
                        <li>German national holidays are highlighted in red</li>
                        <li>Baden-Württemberg regional holidays are included</li>
                        <li>Holiday list is shown on the right panel</li>
                    </ul>

                    <h3>Manage Projects & Locations</h3>
                    <ul>
                        <li>Select "Project" or "Location" from the dropdown</li>
                        <li>Add new entries using the input field</li>
                        <li>Click <span class="shortcut">×</span> to remove a project</li>
                        <li>Projects appear as columns in your timesheet</li>
                    </ul>

                    <h3>Project Overview</h3>
                    <ul>
                        <li>Click "Project Overview" to see hours per project</li>
                        <li>Shows total hours, percentage, and average per day</li>
                        <li>Can be printed or exported to Excel/CSV</li>
                    </ul>

                    <h3>Import & Export</h3>
                    <ul>
                        <li><strong>Import CSV</strong> - Load data from a CSV file</li>
                        <li><strong>Export CSV</strong> - Save data as CSV for backup</li>
                        <li><strong>Export Excel</strong> - Download as formatted .xlsx report</li>
                        <li><strong>Email</strong> - Send summary via email</li>
                        <li><strong>Share</strong> - Copy summary to clipboard</li>
                        <li><strong>Print</strong> - Print current view</li>
                    </ul>

                    <h3>Tips</h3>
                    <ul>
                        <li>Weekend days are highlighted in gray</li>
                        <li>Holidays are highlighted in red</li>
                        <li>Today's row is highlighted in yellow</li>
                        <li>Scroll horizontally if you have many projects</li>
                        <li>Your data is saved automatically</li>
                        <li>Switch language using EN/DE buttons</li>
                    </ul>
                `
            },
            de: {
                name: 'Name:',
                yourName: 'Ihr Name',
                share: 'Teilen',
                email: 'E-Mail',
                exportExcel: 'Excel Export',
                exportCSV: 'CSV Export',
                importCSV: 'CSV Import',
                print: 'Drucken',
                day: 'Tag',
                week: 'Woche',
                month: 'Monat',
                year: 'Jahr',
                totalHours: 'Gesamtstunden',
                target: 'Soll (8h/Tag)',
                overtime: 'Überstunden',
                workDays: 'Arbeitstage',
                projects: 'Projekte',
                newProject: 'Neues Projekt',
                newEntry: 'Neuer Eintrag',
                add: 'Einfügen',
                project: 'Projekt',
                locationOption: 'Arbeitsort',
                scrollHint: 'Scrollen →',
                date: 'Datum',
                duration: 'Dauer',
                location: 'Arbeitsort',
                notes: 'Bemerkung',
                total: 'Summe',
                office: 'Büro',
                homeOffice: 'Home-Office',
                onSite: 'Vor Ort',
                vacation: 'Urlaub',
                holiday: 'Feiertag',
                projectExists: 'Projekt existiert bereits',
                projectAdded: 'Projekt hinzugefügt',
                locationAdded: 'Arbeitsort hinzugefügt',
                locationExists: 'Arbeitsort existiert bereits',
                removeProject: 'Projekt entfernen',
                excelExported: 'Excel exportiert',
                csvExported: 'CSV exportiert',
                csvImported: 'CSV importiert',
                csvImportError: 'Fehler beim CSV-Import',
                copiedClipboard: 'In Zwischenablage kopiert',
                couldNotShare: 'Teilen nicht möglich',
                timesheet: 'Stundenzettel',
                totalLabel: 'Gesamt',
                byLabel: 'Von',
                projectBreakdown: 'Projektaufschlüsselung',
                helpTitle: 'TOM - Benutzerhandbuch',
                holidays: 'Feiertage',
                noHolidays: 'Keine Feiertage in diesem Zeitraum',
                projectOverview: 'Projekt Übersicht',
                hours: 'Stunden',
                percentage: 'Prozent',
                averagePerDay: 'Durchschnitt/Tag',
                projectName: 'Projektname',
                loadGitHub: 'Von GitHub laden',
                githubInstructions: 'Geben Sie die Raw-URL Ihrer CSV-Datei von GitHub ein. Sie erhalten diese, indem Sie auf "Raw" bei Ihrer CSV-Datei in GitHub klicken.',
                githubUrl: 'GitHub Raw URL:',
                saveUrlForFuture: 'URL für zukünftige Nutzung speichern',
                cancel: 'Abbrechen',
                load: 'Laden',
                howToUse: 'So funktioniert es:',
                step1: 'Exportieren Sie Ihre Daten als CSV mit "CSV Export"',
                step2: 'Laden Sie die CSV-Datei in Ihr GitHub-Repository hoch',
                step3: 'Klicken Sie auf den "Raw"-Button auf der Dateiseite',
                step4: 'Kopieren Sie die URL und fügen Sie sie hier ein',
                githubLoaded: 'Daten von GitHub geladen',
                githubError: 'Fehler beim Laden von GitHub',
                githubNoUrl: 'Bitte geben Sie eine GitHub-URL ein',
                days: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'],
                months: ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'],
                helpContent: `
                    <h3>Erste Schritte</h3>
                    <p>TOM ist eine einfache Stundenzettel-Anwendung zur Erfassung Ihrer Arbeitszeiten nach Projekten. Alle Daten werden lokal in Ihrem Browser gespeichert.</p>

                    <h3>Stunden Eingeben</h3>
                    <ul>
                        <li>Klicken Sie auf eine Zelle im Raster, um Stunden für das Projekt/Tag einzugeben</li>
                        <li>Verwenden Sie Dezimalwerte für Teilstunden (z.B. 0,5 für 30 Minuten, 0,25 für 15 Minuten)</li>
                        <li>Dauer und Überstunden werden automatisch berechnet</li>
                        <li>Wählen Sie Ihren Arbeitsort aus dem Dropdown-Menü</li>
                        <li>Fügen Sie Bemerkungen hinzu, um Ihre Arbeit zu beschreiben</li>
                        <li>An Feiertagen wird der Arbeitsort automatisch auf "Feiertag" gesetzt</li>
                    </ul>

                    <h3>Ansichtsoptionen</h3>
                    <ul>
                        <li><strong>Tag</strong> - Einen einzelnen Tag anzeigen</li>
                        <li><strong>Woche</strong> - Montag bis Sonntag anzeigen</li>
                        <li><strong>Monat</strong> - Gesamten Monat anzeigen (Standard)</li>
                        <li><strong>Jahr</strong> - Gesamtes Jahr anzeigen</li>
                    </ul>
                    <p>Verwenden Sie die Pfeiltasten, um zwischen Zeiträumen zu navigieren.</p>

                    <h3>Feiertage</h3>
                    <ul>
                        <li>Deutsche Feiertage sind rot markiert</li>
                        <li>Baden-Württemberg regionale Feiertage sind enthalten</li>
                        <li>Feiertagsliste wird rechts angezeigt</li>
                    </ul>

                    <h3>Projekte & Arbeitsorte Verwalten</h3>
                    <ul>
                        <li>Wählen Sie "Projekt" oder "Arbeitsort" aus dem Dropdown</li>
                        <li>Fügen Sie neue Einträge über das Eingabefeld hinzu</li>
                        <li>Klicken Sie auf <span class="shortcut">×</span>, um ein Projekt zu entfernen</li>
                        <li>Projekte erscheinen als Spalten in Ihrem Stundenzettel</li>
                    </ul>

                    <h3>Projekt Übersicht</h3>
                    <ul>
                        <li>Klicken Sie auf "Projekt Übersicht" um Stunden pro Projekt zu sehen</li>
                        <li>Zeigt Gesamtstunden, Prozent und Durchschnitt pro Tag</li>
                        <li>Kann gedruckt oder als Excel/CSV exportiert werden</li>
                    </ul>

                    <h3>Import & Export</h3>
                    <ul>
                        <li><strong>CSV Import</strong> - Daten aus CSV-Datei laden</li>
                        <li><strong>CSV Export</strong> - Daten als CSV für Backup speichern</li>
                        <li><strong>Excel Export</strong> - Als formatierte .xlsx-Datei herunterladen</li>
                        <li><strong>E-Mail</strong> - Zusammenfassung per E-Mail senden</li>
                        <li><strong>Teilen</strong> - Zusammenfassung in Zwischenablage kopieren</li>
                        <li><strong>Drucken</strong> - Aktuelle Ansicht drucken</li>
                    </ul>

                    <h3>Tipps</h3>
                    <ul>
                        <li>Wochenendtage sind grau markiert</li>
                        <li>Feiertage sind rot markiert</li>
                        <li>Die heutige Zeile ist gelb markiert</li>
                        <li>Scrollen Sie horizontal, wenn Sie viele Projekte haben</li>
                        <li>Ihre Daten werden automatisch gespeichert</li>
                        <li>Sprache mit EN/DE-Buttons wechseln</li>
                    </ul>
                `
            }
        };

        // State
        let currentLang = 'en';
        let entries = {};
        let projects = [];
        let customLocations = [];
        let settings = { userName: '', targetHoursPerDay: 8, language: 'en' };
        let currentView = 'month';
        let currentDate = new Date();
        let holidayCache = {};

        // Get translation
        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        // Get locations based on language (including custom locations)
        function getLocations() {
            const defaultLocs = [t('office'), t('homeOffice'), t('onSite'), t('vacation'), t('holiday')];
            const allLocs = [...defaultLocs, ...customLocations, '-'];
            return [...new Set(allLocs)];
        }

        // Get holiday name based on language
        function getHolidayName(holiday) {
            return currentLang === 'de' ? holiday.de : holiday.en;
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupViewButtons();
            setupLangButtons();
            checkScrollHint();
            applyTranslations();
            render();

            window.addEventListener('resize', checkScrollHint);
            document.getElementById('timesheetScroll').addEventListener('scroll', checkScrollHint);

            document.getElementById('helpModal').addEventListener('click', (e) => {
                if (e.target.id === 'helpModal') closeHelp();
            });

            document.getElementById('overviewModal').addEventListener('click', (e) => {
                if (e.target.id === 'overviewModal') closeOverview();
            });

            document.getElementById('githubModal').addEventListener('click', (e) => {
                if (e.target.id === 'githubModal') closeGitHubModal();
            });
        });

        // Help Modal
        function showHelp() {
            document.getElementById('helpBody').innerHTML = t('helpContent');
            document.getElementById('helpModal').classList.add('show');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('show');
        }

        // Project Overview Modal
        function showProjectOverview() {
            const dates = getViewDates();
            const periodLabel = getPeriodLabel();

            const projectTotals = {};
            projects.forEach(p => projectTotals[p] = 0);
            let totalHours = 0;
            let workDays = 0;

            dates.forEach(date => {
                const dateStr = formatDate(date);
                const entry = entries[dateStr] || {};
                let dayHours = 0;

                projects.forEach(p => {
                    const h = entry[p] || 0;
                    projectTotals[p] += h;
                    dayHours += h;
                });

                if (dayHours > 0) workDays++;
                totalHours += dayHours;
            });

            let html = `
                <h3>${t('timesheet')}: ${periodLabel}</h3>
                <p>${t('byLabel')}: ${settings.userName || 'User'}</p>

                <div class="overview-summary">
                    <div class="overview-stat">
                        <div class="stat-value">${totalHours.toFixed(2)}</div>
                        <div class="stat-label">${t('totalHours')}</div>
                    </div>
                    <div class="overview-stat">
                        <div class="stat-value">${workDays}</div>
                        <div class="stat-label">${t('workDays')}</div>
                    </div>
                    <div class="overview-stat">
                        <div class="stat-value">${workDays > 0 ? (totalHours / workDays).toFixed(2) : '0.00'}</div>
                        <div class="stat-label">${t('averagePerDay')}</div>
                    </div>
                </div>

                <table class="overview-table">
                    <thead>
                        <tr>
                            <th>${t('projectName')}</th>
                            <th>${t('hours')}</th>
                            <th>${t('percentage')}</th>
                            <th>${t('averagePerDay')}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const sortedProjects = Object.entries(projectTotals)
                .filter(([_, hours]) => hours > 0)
                .sort((a, b) => b[1] - a[1]);

            sortedProjects.forEach(([project, hours]) => {
                const percentage = totalHours > 0 ? (hours / totalHours * 100).toFixed(1) : '0.0';
                const avgPerDay = workDays > 0 ? (hours / workDays).toFixed(2) : '0.00';
                html += `
                    <tr>
                        <td>${escapeHtml(project)}</td>
                        <td class="hours-cell">${hours.toFixed(2)}</td>
                        <td class="percent-cell">${percentage}%</td>
                        <td class="hours-cell">${avgPerDay}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td>${t('total')}</td>
                            <td class="hours-cell">${totalHours.toFixed(2)}</td>
                            <td class="percent-cell">100%</td>
                            <td class="hours-cell">${workDays > 0 ? (totalHours / workDays).toFixed(2) : '0.00'}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            document.getElementById('overviewBody').innerHTML = html;
            document.getElementById('overviewModal').classList.add('show');
        }

        function closeOverview() {
            document.getElementById('overviewModal').classList.remove('show');
            document.getElementById('overviewModal').classList.remove('print-mode');
        }

        // GitHub Modal Functions
        function showGitHubModal() {
            const savedUrl = localStorage.getItem('tom_github_url') || '';
            document.getElementById('githubUrl').value = savedUrl;
            document.getElementById('githubModal').classList.add('show');
            applyTranslations();
        }

        function closeGitHubModal() {
            document.getElementById('githubModal').classList.remove('show');
        }

        async function loadFromGitHub() {
            const url = document.getElementById('githubUrl').value.trim();
            const saveUrl = document.getElementById('githubSaveUrl').checked;

            if (!url) {
                showStatus(t('githubNoUrl'));
                return;
            }

            // Convert GitHub URL to raw URL if needed
            let rawUrl = url;
            if (url.includes('github.com') && !url.includes('raw.githubusercontent.com')) {
                rawUrl = url
                    .replace('github.com', 'raw.githubusercontent.com')
                    .replace('/blob/', '/');
            }

            try {
                const response = await fetch(rawUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const csvText = await response.text();

                // Parse the CSV
                const lines = csvText.split('\n').filter(l => l.trim());
                if (lines.length < 2) {
                    throw new Error('Invalid CSV format');
                }

                // Parse header
                const header = parseCSVLine(lines[0]);
                const dateColIndex = 0;
                const projectCols = [];
                const locationColIndex = header.findIndex(h =>
                    h.toLowerCase() === 'location' ||
                    h.toLowerCase() === 'arbeitsort' ||
                    h === t('location')
                );
                const notesColIndex = header.findIndex(h =>
                    h.toLowerCase() === 'notes' ||
                    h.toLowerCase() === 'bemerkung' ||
                    h === t('notes')
                );

                // Find project columns
                const skipCols = [t('date'), t('duration'), t('overtime'), t('location'), t('notes'),
                                 'date', 'duration', 'overtime', 'location', 'notes',
                                 'datum', 'dauer', 'überstunden', 'arbeitsort', 'bemerkung'];

                header.forEach((h, i) => {
                    if (i === 0) return;
                    if (!skipCols.some(s => h.toLowerCase() === s.toLowerCase())) {
                        projectCols.push({ index: i, name: h });
                    }
                });

                // Add new projects if not exist
                projectCols.forEach(pc => {
                    if (!projects.includes(pc.name)) {
                        projects.push(pc.name);
                    }
                });

                // Parse data rows
                for (let i = 1; i < lines.length; i++) {
                    const row = parseCSVLine(lines[i]);
                    if (!row[0] || row[0].toLowerCase().includes('total') || row[0].toLowerCase().includes('summe')) {
                        continue;
                    }

                    const dateMatch = row[0].match(/(\d{1,2})\.(\d{1,2})(?:\.(\d{4}))?/);
                    if (!dateMatch) continue;

                    const day = parseInt(dateMatch[1]);
                    const month = parseInt(dateMatch[2]) - 1;
                    const year = dateMatch[3] ? parseInt(dateMatch[3]) : currentDate.getFullYear();
                    const date = new Date(year, month, day);
                    const dateStr = formatDate(date);

                    if (!entries[dateStr]) entries[dateStr] = {};

                    projectCols.forEach(pc => {
                        const hours = parseFloat(row[pc.index]) || 0;
                        if (hours > 0) {
                            entries[dateStr][pc.name] = hours;
                        }
                    });

                    if (locationColIndex >= 0 && row[locationColIndex]) {
                        entries[dateStr].location = row[locationColIndex];
                    }

                    if (notesColIndex >= 0 && row[notesColIndex]) {
                        entries[dateStr].notes = row[notesColIndex];
                    }
                }

                // Save URL if requested
                if (saveUrl) {
                    localStorage.setItem('tom_github_url', url);
                }

                saveData();
                render();
                closeGitHubModal();
                showStatus(t('githubLoaded'));

            } catch (err) {
                console.error('GitHub load error:', err);
                showStatus(t('githubError') + ': ' + err.message);
            }
        }

        function printOverview() {
            const modal = document.getElementById('overviewModal');
            modal.classList.add('print-mode');
            window.print();
            setTimeout(() => modal.classList.remove('print-mode'), 500);
        }

        function exportOverviewCSV() {
            const dates = getViewDates();
            const periodLabel = getPeriodLabel();

            const projectTotals = {};
            projects.forEach(p => projectTotals[p] = 0);
            let totalHours = 0;
            let workDays = 0;

            dates.forEach(date => {
                const entry = entries[formatDate(date)] || {};
                let dayHours = 0;
                projects.forEach(p => {
                    const h = entry[p] || 0;
                    projectTotals[p] += h;
                    dayHours += h;
                });
                if (dayHours > 0) workDays++;
                totalHours += dayHours;
            });

            let csv = `${t('projectOverview')}: ${periodLabel}\n`;
            csv += `${t('byLabel')}: ${settings.userName || 'User'}\n\n`;
            csv += `${t('projectName')},${t('hours')},${t('percentage')},${t('averagePerDay')}\n`;

            Object.entries(projectTotals)
                .filter(([_, h]) => h > 0)
                .sort((a, b) => b[1] - a[1])
                .forEach(([project, hours]) => {
                    const pct = totalHours > 0 ? (hours / totalHours * 100).toFixed(1) : '0.0';
                    const avg = workDays > 0 ? (hours / workDays).toFixed(2) : '0.00';
                    csv += `"${project}",${hours.toFixed(2)},${pct}%,${avg}\n`;
                });

            csv += `${t('total')},${totalHours.toFixed(2)},100%,${workDays > 0 ? (totalHours / workDays).toFixed(2) : '0.00'}\n`;

            downloadFile(csv, `${t('projectOverview')}_${periodLabel.replace(/\s+/g, '_')}.csv`, 'text/csv');
            showStatus(t('csvExported'));
        }

        function exportOverviewExcel() {
            const dates = getViewDates();
            const periodLabel = getPeriodLabel();

            const projectTotals = {};
            projects.forEach(p => projectTotals[p] = 0);
            let totalHours = 0;
            let workDays = 0;

            dates.forEach(date => {
                const entry = entries[formatDate(date)] || {};
                let dayHours = 0;
                projects.forEach(p => {
                    const h = entry[p] || 0;
                    projectTotals[p] += h;
                    dayHours += h;
                });
                if (dayHours > 0) workDays++;
                totalHours += dayHours;
            });

            const wb = XLSX.utils.book_new();
            const wsData = [];

            // Title
            wsData.push([`${t('projectOverview')}: ${periodLabel}`]);
            wsData.push([`${t('byLabel')}: ${settings.userName || 'User'}`]);
            wsData.push([]);

            // Summary
            wsData.push([t('totalHours'), totalHours.toFixed(2)]);
            wsData.push([t('workDays'), workDays]);
            wsData.push([t('averagePerDay'), workDays > 0 ? (totalHours / workDays).toFixed(2) : '0.00']);
            wsData.push([]);

            // Header
            wsData.push([t('projectName'), t('hours'), t('percentage'), t('averagePerDay')]);

            // Data
            Object.entries(projectTotals)
                .filter(([_, h]) => h > 0)
                .sort((a, b) => b[1] - a[1])
                .forEach(([project, hours]) => {
                    const pct = totalHours > 0 ? (hours / totalHours * 100).toFixed(1) + '%' : '0.0%';
                    const avg = workDays > 0 ? (hours / workDays).toFixed(2) : '0.00';
                    wsData.push([project, hours, pct, avg]);
                });

            // Total row
            wsData.push([t('total'), totalHours, '100%', workDays > 0 ? (totalHours / workDays).toFixed(2) : '0.00']);

            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Column widths
            ws['!cols'] = [{ wch: 30 }, { wch: 12 }, { wch: 12 }, { wch: 15 }];

            // Add borders and styling
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cell_ref]) continue;
                    if (!ws[cell_ref].s) ws[cell_ref].s = {};
                    ws[cell_ref].s.border = {
                        top: { style: 'thin', color: { rgb: '000000' } },
                        bottom: { style: 'thin', color: { rgb: '000000' } },
                        left: { style: 'thin', color: { rgb: '000000' } },
                        right: { style: 'thin', color: { rgb: '000000' } }
                    };
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, t('projectOverview').substring(0, 31));

            const filename = `${t('projectOverview')}_${periodLabel.replace(/\s+/g, '_')}.xlsx`;
            XLSX.writeFile(wb, filename);
            showStatus(t('excelExported'));
        }

        // Language buttons
        function setupLangButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentLang = btn.dataset.lang;
                    settings.language = currentLang;
                    saveData();
                    applyTranslations();
                    render();
                });
            });
        }

        // Apply translations to UI
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (key !== 'helpContent') {
                    el.textContent = t(key);
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.dataset.i18nPlaceholder;
                el.placeholder = t(key);
            });
        }

        // Check if horizontal scroll is needed
        function checkScrollHint() {
            const wrapper = document.getElementById('timesheetScroll');
            const hint = document.getElementById('scrollHint');
            if (wrapper && wrapper.scrollWidth > wrapper.clientWidth && wrapper.scrollLeft < 50) {
                hint.classList.add('show');
            } else if (hint) {
                hint.classList.remove('show');
            }
        }

        // View Buttons
        function setupViewButtons() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    currentDate = new Date();
                    render();
                });
            });
        }

        // Data
        function loadData() {
            entries = JSON.parse(localStorage.getItem('tom_entries') || '{}');
            projects = JSON.parse(localStorage.getItem('tom_projects') || '["Project A", "Project B", "Meeting", "Training"]');
            customLocations = JSON.parse(localStorage.getItem('tom_locations') || '[]');
            const savedSettings = JSON.parse(localStorage.getItem('tom_settings') || '{}');
            settings = { ...settings, ...savedSettings };
            document.getElementById('userName').value = settings.userName || '';

            currentLang = settings.language || 'en';
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
        }

        function saveData() {
            localStorage.setItem('tom_entries', JSON.stringify(entries));
            localStorage.setItem('tom_projects', JSON.stringify(projects));
            localStorage.setItem('tom_locations', JSON.stringify(customLocations));
            localStorage.setItem('tom_settings', JSON.stringify(settings));
        }

        function saveSettings() {
            settings.userName = document.getElementById('userName').value;
            saveData();
        }

        // Period Navigation
        function prevPeriod() {
            if (currentView === 'day') currentDate.setDate(currentDate.getDate() - 1);
            else if (currentView === 'week') currentDate.setDate(currentDate.getDate() - 7);
            else if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() - 1);
            else if (currentView === 'year') currentDate.setFullYear(currentDate.getFullYear() - 1);
            render();
        }

        function nextPeriod() {
            if (currentView === 'day') currentDate.setDate(currentDate.getDate() + 1);
            else if (currentView === 'week') currentDate.setDate(currentDate.getDate() + 7);
            else if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() + 1);
            else if (currentView === 'year') currentDate.setFullYear(currentDate.getFullYear() + 1);
            render();
        }

        // Get dates for current view
        function getViewDates() {
            const dates = [];
            const d = new Date(currentDate);

            if (currentView === 'day') {
                dates.push(new Date(d));
            } else if (currentView === 'week') {
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                d.setDate(diff);
                for (let i = 0; i < 7; i++) {
                    dates.push(new Date(d));
                    d.setDate(d.getDate() + 1);
                }
            } else if (currentView === 'month') {
                d.setDate(1);
                const month = d.getMonth();
                while (d.getMonth() === month) {
                    dates.push(new Date(d));
                    d.setDate(d.getDate() + 1);
                }
            } else if (currentView === 'year') {
                d.setMonth(0, 1);
                const year = d.getFullYear();
                while (d.getFullYear() === year) {
                    dates.push(new Date(d));
                    d.setDate(d.getDate() + 1);
                }
            }

            return dates;
        }

        function getPeriodLabel() {
            const d = new Date(currentDate);
            const months = t('months');
            const days = t('days');

            if (currentView === 'day') {
                return `${days[d.getDay()]}, ${d.getDate()}. ${months[d.getMonth()]} ${d.getFullYear()}`;
            } else if (currentView === 'week') {
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const monday = new Date(d.setDate(diff));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                return `${monday.getDate()}. ${months[monday.getMonth()]} - ${sunday.getDate()}. ${months[sunday.getMonth()]} ${sunday.getFullYear()}`;
            } else if (currentView === 'month') {
                return `${months[d.getMonth()]} ${d.getFullYear()}`;
            } else {
                return d.getFullYear().toString();
            }
        }

        // Render
        function render() {
            document.getElementById('periodLabel').textContent = getPeriodLabel();
            renderTable();
            renderProjectList();
            renderHolidayList();
            setTimeout(checkScrollHint, 100);
        }

        function renderTable() {
            const dates = getViewDates();
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const tfoot = document.getElementById('tableFoot');
            const today = formatDate(new Date());
            const locations = getLocations();

            // Get holidays for all years in view
            const years = [...new Set(dates.map(d => d.getFullYear()))];
            const holidayMap = {};
            years.forEach(year => {
                Object.assign(holidayMap, getHolidayMap(year));
            });

            // Header
            let headerHtml = `<tr><th>${t('date')}</th>`;
            projects.forEach(p => {
                headerHtml += `<th class="project-header" title="${escapeHtml(p)}">${escapeHtml(p)}</th>`;
            });
            headerHtml += `<th>${t('duration')}</th><th>${t('overtime')}</th><th>${t('location')}</th><th>${t('notes')}</th></tr>`;
            thead.innerHTML = headerHtml;

            // Body
            let bodyHtml = '';
            const projectTotals = {};
            projects.forEach(p => projectTotals[p] = 0);
            let totalMinutes = 0;
            let totalOvertime = 0;
            let workDays = 0;

            dates.forEach(date => {
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const holiday = holidayMap[dateStr];
                const isHoliday = !!holiday;
                const isToday = dateStr === today;
                const entry = entries[dateStr] || {};

                let dayMinutes = 0;
                let rowClasses = [];
                if (isWeekend) rowClasses.push('weekend');
                if (isHoliday) rowClasses.push('holiday');
                if (isToday) rowClasses.push('today');
                const rowClass = rowClasses.join(' ');

                bodyHtml += `<tr>`;
                bodyHtml += `<td class="date-cell ${rowClass}" title="${isHoliday ? getHolidayName(holiday) : ''}">${formatDateDisplay(date)}${isHoliday ? ' *' : ''}</td>`;

                projects.forEach(p => {
                    const hours = entry[p] || 0;
                    dayMinutes += hours * 60;
                    projectTotals[p] += hours;
                    bodyHtml += `<td class="${rowClass}"><input type="number" min="0" max="24" step="0.25" value="${hours || ''}" onchange="updateEntry('${dateStr}', '${escapeAttr(p)}', this.value)"></td>`;
                });

                const duration = dayMinutes / 60;
                const overtime = duration > 0 ? duration - settings.targetHoursPerDay : 0;
                totalMinutes += dayMinutes;
                if (duration > 0) {
                    totalOvertime += overtime;
                    workDays++;
                }

                // For holidays, default location is "Feiertag"
                let location = entry.location || (isHoliday ? t('holiday') : '-');
                const notes = entry.notes || '';

                bodyHtml += `<td class="duration-cell ${rowClass}">${duration > 0 ? duration.toFixed(2) : '-'}</td>`;
                bodyHtml += `<td class="overtime-cell ${overtime >= 0 ? 'positive' : ''} ${rowClass}">${duration > 0 ? (overtime >= 0 ? '+' : '') + overtime.toFixed(2) : '-'}</td>`;
                bodyHtml += `<td class="${rowClass}"><select onchange="updateLocation('${dateStr}', this.value)" ${isHoliday ? 'data-holiday="true"' : ''}>`;
                locations.forEach(loc => {
                    bodyHtml += `<option value="${loc}" ${location === loc ? 'selected' : ''}>${loc}</option>`;
                });
                bodyHtml += `</select></td>`;
                bodyHtml += `<td class="${rowClass}"><input type="text" value="${escapeHtml(notes)}" onchange="updateNotes('${dateStr}', this.value)" placeholder="..."></td>`;
                bodyHtml += `</tr>`;
            });

            tbody.innerHTML = bodyHtml;

            // Footer
            let footHtml = `<tr><td><strong>${t('total')}</strong></td>`;
            projects.forEach(p => {
                footHtml += `<td><strong>${projectTotals[p].toFixed(2)}</strong></td>`;
            });
            footHtml += `<td><strong>${(totalMinutes / 60).toFixed(2)}</strong></td>`;
            footHtml += `<td class="overtime-cell ${totalOvertime >= 0 ? 'positive' : ''}"><strong>${(totalOvertime >= 0 ? '+' : '') + totalOvertime.toFixed(2)}</strong></td>`;
            footHtml += `<td></td><td></td></tr>`;
            tfoot.innerHTML = footHtml;

            // Update summary
            document.getElementById('totalHours').textContent = formatHours(totalMinutes);
            document.getElementById('targetHours').textContent = formatHours(workDays * settings.targetHoursPerDay * 60);
            document.getElementById('overtimeHours').textContent = (totalOvertime >= 0 ? '+' : '') + formatHours(totalOvertime * 60);
            document.getElementById('workDays').textContent = workDays;

            const overtimeCard = document.getElementById('overtimeCard');
            overtimeCard.classList.toggle('positive', totalOvertime >= 0);
        }

        function renderHolidayList() {
            const dates = getViewDates();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const years = [...new Set(dates.map(d => d.getFullYear()))];
            let allHolidays = [];
            years.forEach(year => {
                allHolidays = allHolidays.concat(getHolidaysForYear(year));
            });

            const startDate = dates[0];
            const endDate = dates[dates.length - 1];
            const periodHolidays = allHolidays.filter(h =>
                h.date >= startDate && h.date <= endDate
            );

            const container = document.getElementById('holidayList');

            if (periodHolidays.length === 0) {
                container.innerHTML = `<div class="no-holidays">${t('noHolidays')}</div>`;
                return;
            }

            container.innerHTML = periodHolidays.map(h => {
                const isPast = h.date < today;
                const dayName = t('days')[h.date.getDay()];
                return `
                    <div class="holiday-item ${isPast ? 'past' : ''}">
                        <div class="holiday-date">${dayName} ${pad(h.date.getDate())}.${pad(h.date.getMonth() + 1)}.${h.date.getFullYear()}</div>
                        <div class="holiday-name">${getHolidayName(h)}${h.bw ? ' (BW)' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function renderProjectList() {
            document.getElementById('projectList').innerHTML = projects.map(p =>
                `<span class="project-tag">${escapeHtml(p)} <span class="remove" onclick="removeProject('${escapeAttr(p)}')">&times;</span></span>`
            ).join('');
        }

        // Update functions
        function updateEntry(dateStr, project, value) {
            if (!entries[dateStr]) entries[dateStr] = {};
            const hours = parseFloat(value) || 0;
            if (hours > 0) {
                entries[dateStr][project] = hours;
            } else {
                delete entries[dateStr][project];
            }
            saveData();
            render();
        }

        function updateLocation(dateStr, value) {
            if (!entries[dateStr]) entries[dateStr] = {};
            entries[dateStr].location = value;
            saveData();
        }

        function updateNotes(dateStr, value) {
            if (!entries[dateStr]) entries[dateStr] = {};
            entries[dateStr].notes = value;
            saveData();
        }

        // Add entry (project or location)
        function addEntry() {
            const typeSelect = document.getElementById('addType');
            const input = document.getElementById('newProject');
            const name = input.value.trim();
            const type = typeSelect.value;

            if (!name) return;

            if (type === 'project') {
                if (projects.includes(name)) {
                    showStatus(t('projectExists'));
                    return;
                }
                projects.push(name);
                showStatus(t('projectAdded'));
            } else {
                if (customLocations.includes(name)) {
                    showStatus(t('locationExists'));
                    return;
                }
                customLocations.push(name);
                showStatus(t('locationAdded'));
            }

            saveData();
            input.value = '';
            render();
        }

        // Legacy function for backward compatibility
        function addProject() {
            const input = document.getElementById('newProject');
            const name = input.value.trim();
            if (!name) return;
            if (projects.includes(name)) {
                showStatus(t('projectExists'));
                return;
            }
            projects.push(name);
            saveData();
            input.value = '';
            render();
            showStatus(t('projectAdded'));
        }

        function removeProject(name) {
            if (!confirm(`${t('removeProject')} "${name}"?`)) return;
            projects = projects.filter(p => p !== name);
            saveData();
            render();
        }

        // Helpers
        function formatDate(d) {
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        }

        function formatDateDisplay(d) {
            const days = t('days');
            return `${days[d.getDay()]} ${pad(d.getDate())}.${pad(d.getMonth() + 1)}`;
        }

        function formatHours(minutes) {
            const h = Math.floor(Math.abs(minutes) / 60);
            const m = Math.abs(minutes) % 60;
            return `${minutes < 0 ? '-' : ''}${h}:${pad(Math.round(m))}`;
        }

        function pad(n) {
            return n.toString().padStart(2, '0');
        }

        function escapeHtml(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function escapeAttr(str) {
            return String(str).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }

        function showStatus(msg) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type + ';charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // CSV Export
        function exportCSV() {
            const dates = getViewDates();
            const periodLabel = getPeriodLabel();

            const years = [...new Set(dates.map(d => d.getFullYear()))];
            const holidayMap = {};
            years.forEach(year => {
                Object.assign(holidayMap, getHolidayMap(year));
            });

            let csv = '';

            // Header
            const header = [t('date'), ...projects, t('duration'), t('overtime'), t('location'), t('notes')];
            csv += header.map(h => `"${h}"`).join(',') + '\n';

            // Data rows
            dates.forEach(date => {
                const dateStr = formatDate(date);
                const entry = entries[dateStr] || {};
                const holiday = holidayMap[dateStr];

                let dayHours = 0;
                let dateLabel = formatDateDisplay(date);
                if (holiday) dateLabel += ` (${getHolidayName(holiday)})`;

                const row = [`"${dateLabel}"`];

                projects.forEach(p => {
                    const h = entry[p] || 0;
                    dayHours += h;
                    row.push(h || '');
                });

                const overtime = dayHours > 0 ? dayHours - settings.targetHoursPerDay : 0;

                row.push(dayHours || '');
                row.push(dayHours > 0 ? overtime : '');
                row.push(`"${entry.location || ''}"`);
                row.push(`"${(entry.notes || '').replace(/"/g, '""')}"`);

                csv += row.join(',') + '\n';
            });

            // Total row
            const projectTotals = {};
            let totalHours = 0;
            let totalOvertime = 0;

            projects.forEach(p => projectTotals[p] = 0);

            dates.forEach(date => {
                const entry = entries[formatDate(date)] || {};
                let dayHours = 0;
                projects.forEach(p => {
                    const h = entry[p] || 0;
                    projectTotals[p] += h;
                    dayHours += h;
                });
                if (dayHours > 0) {
                    totalHours += dayHours;
                    totalOvertime += dayHours - settings.targetHoursPerDay;
                }
            });

            const totalRow = [`"${t('total')}"`];
            projects.forEach(p => totalRow.push(projectTotals[p]));
            totalRow.push(totalHours);
            totalRow.push(totalOvertime);
            totalRow.push('');
            totalRow.push('');
            csv += totalRow.join(',') + '\n';

            const filename = `${t('timesheet')}_${periodLabel.replace(/\s+/g, '_')}.csv`;
            downloadFile(csv, filename, 'text/csv');
            showStatus(t('csvExported'));
        }

        // CSV Import
        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(l => l.trim());

                    if (lines.length < 2) {
                        showStatus(t('csvImportError'));
                        return;
                    }

                    // Parse header
                    const header = parseCSVLine(lines[0]);
                    const dateColIndex = 0;
                    const projectCols = [];
                    const locationColIndex = header.findIndex(h =>
                        h.toLowerCase() === 'location' ||
                        h.toLowerCase() === 'arbeitsort' ||
                        h === t('location')
                    );
                    const notesColIndex = header.findIndex(h =>
                        h.toLowerCase() === 'notes' ||
                        h.toLowerCase() === 'bemerkung' ||
                        h === t('notes')
                    );

                    // Find project columns (skip date, duration, overtime, location, notes)
                    const skipCols = [t('date'), t('duration'), t('overtime'), t('location'), t('notes'),
                                     'date', 'duration', 'overtime', 'location', 'notes',
                                     'datum', 'dauer', 'überstunden', 'arbeitsort', 'bemerkung'];

                    header.forEach((h, i) => {
                        if (i === 0) return; // Skip date column
                        if (!skipCols.some(s => h.toLowerCase() === s.toLowerCase())) {
                            projectCols.push({ index: i, name: h });
                        }
                    });

                    // Add new projects if not exist
                    projectCols.forEach(pc => {
                        if (!projects.includes(pc.name)) {
                            projects.push(pc.name);
                        }
                    });

                    // Parse data rows (skip header and total row)
                    for (let i = 1; i < lines.length; i++) {
                        const row = parseCSVLine(lines[i]);
                        if (!row[0] || row[0].toLowerCase().includes('total') || row[0].toLowerCase().includes('summe')) {
                            continue;
                        }

                        // Try to extract date from the first column
                        const dateMatch = row[0].match(/(\d{1,2})\.(\d{1,2})(?:\.(\d{4}))?/);
                        if (!dateMatch) continue;

                        const day = parseInt(dateMatch[1]);
                        const month = parseInt(dateMatch[2]) - 1;
                        const year = dateMatch[3] ? parseInt(dateMatch[3]) : currentDate.getFullYear();
                        const date = new Date(year, month, day);
                        const dateStr = formatDate(date);

                        if (!entries[dateStr]) entries[dateStr] = {};

                        // Import project hours
                        projectCols.forEach(pc => {
                            const hours = parseFloat(row[pc.index]) || 0;
                            if (hours > 0) {
                                entries[dateStr][pc.name] = hours;
                            }
                        });

                        // Import location
                        if (locationColIndex >= 0 && row[locationColIndex]) {
                            entries[dateStr].location = row[locationColIndex];
                        }

                        // Import notes
                        if (notesColIndex >= 0 && row[notesColIndex]) {
                            entries[dateStr].notes = row[notesColIndex];
                        }
                    }

                    saveData();
                    render();
                    showStatus(t('csvImported'));
                } catch (err) {
                    console.error(err);
                    showStatus(t('csvImportError'));
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Export Excel with nice formatting
        function exportExcel() {
            const dates = getViewDates();
            const userName = settings.userName || t('timesheet');
            const periodLabel = getPeriodLabel();

            const years = [...new Set(dates.map(d => d.getFullYear()))];
            const holidayMap = {};
            years.forEach(year => {
                Object.assign(holidayMap, getHolidayMap(year));
            });

            const wb = XLSX.utils.book_new();
            const wsData = [];

            // Title section
            wsData.push([]);
            wsData.push([`  ${t('timesheet').toUpperCase()}`]);
            wsData.push([]);
            wsData.push([`  ${t('name').replace(':', '')}:`, userName]);
            wsData.push([`  ${currentLang === 'de' ? 'Zeitraum' : 'Period'}:`, periodLabel]);
            wsData.push([]);
            wsData.push([]);

            // Header row
            const header = ['', t('date'), ...projects, t('duration'), t('overtime'), t('location'), t('notes')];
            wsData.push(header);

            const projectTotals = {};
            projects.forEach(p => projectTotals[p] = 0);
            let totalHours = 0;
            let totalOvertime = 0;
            let rowNum = 9; // Starting data row

            dates.forEach(date => {
                const dateStr = formatDate(date);
                const entry = entries[dateStr] || {};
                const holiday = holidayMap[dateStr];

                let dayHours = 0;
                let dateLabel = formatDateDisplay(date);
                if (holiday) dateLabel += ` (${getHolidayName(holiday)})`;

                const row = ['', dateLabel];

                projects.forEach(p => {
                    const h = entry[p] || 0;
                    dayHours += h;
                    projectTotals[p] += h;
                    row.push(h || '');
                });

                const overtime = dayHours > 0 ? dayHours - settings.targetHoursPerDay : 0;
                if (dayHours > 0) {
                    totalHours += dayHours;
                    totalOvertime += overtime;
                }

                row.push(dayHours || '');
                row.push(dayHours > 0 ? overtime : '');
                row.push(entry.location || '');
                row.push(entry.notes || '');

                wsData.push(row);
                rowNum++;
            });

            // Total row
            wsData.push([]);
            const totalRow = ['', t('total')];
            projects.forEach(p => totalRow.push(projectTotals[p]));
            totalRow.push(totalHours);
            totalRow.push(totalOvertime);
            totalRow.push('');
            totalRow.push('');
            wsData.push(totalRow);

            // Footer
            wsData.push([]);
            wsData.push([]);
            wsData.push([`  ${currentLang === 'de' ? 'Erstellt am' : 'Generated on'}: ${new Date().toLocaleDateString()}`]);

            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Column widths
            const colWidths = [{ wch: 3 }, { wch: 22 }];
            projects.forEach(() => colWidths.push({ wch: 10 }));
            colWidths.push({ wch: 10 }, { wch: 10 }, { wch: 14 }, { wch: 25 });
            ws['!cols'] = colWidths;

            // Set row heights
            ws['!rows'] = [];
            for (let i = 0; i < wsData.length; i++) {
                ws['!rows'][i] = { hpt: 18 };
            }
            ws['!rows'][1] = { hpt: 28 }; // Title row

            // Apply styling using cell references
            const range = XLSX.utils.decode_range(ws['!ref']);

            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_ref = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cell_ref]) {
                        ws[cell_ref] = { v: '', t: 's' };
                    }
                    if (!ws[cell_ref].s) ws[cell_ref].s = {};

                    // Header row (row 7, 0-indexed)
                    if (R === 7) {
                        ws[cell_ref].s = {
                            font: { bold: true, color: { rgb: 'FFFFFF' } },
                            fill: { fgColor: { rgb: '4472C4' } },
                            alignment: { horizontal: 'center', vertical: 'center' },
                            border: {
                                top: { style: 'medium', color: { rgb: '000000' } },
                                bottom: { style: 'medium', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    }
                    // Data rows
                    else if (R >= 8 && R < rowNum) {
                        const isAlternate = (R - 8) % 2 === 1;
                        ws[cell_ref].s = {
                            fill: { fgColor: { rgb: isAlternate ? 'D9E1F2' : 'FFFFFF' } },
                            alignment: { horizontal: C >= 2 ? 'center' : 'left', vertical: 'center' },
                            border: {
                                top: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                bottom: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                left: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                right: { style: 'thin', color: { rgb: 'CCCCCC' } }
                            }
                        };
                    }
                    // Total row
                    else if (R === rowNum + 1) {
                        ws[cell_ref].s = {
                            font: { bold: true },
                            fill: { fgColor: { rgb: 'E2EFDA' } },
                            alignment: { horizontal: C >= 2 ? 'center' : 'left', vertical: 'center' },
                            border: {
                                top: { style: 'medium', color: { rgb: '000000' } },
                                bottom: { style: 'medium', color: { rgb: '000000' } },
                                left: { style: 'thin', color: { rgb: '000000' } },
                                right: { style: 'thin', color: { rgb: '000000' } }
                            }
                        };
                    }
                    // Title
                    else if (R === 1) {
                        ws[cell_ref].s = {
                            font: { bold: true, sz: 16 },
                            alignment: { horizontal: 'left', vertical: 'center' }
                        };
                    }
                }
            }

            // Add outer border for the data section
            const dataStartRow = 7;
            const dataEndRow = rowNum + 1;
            const dataEndCol = header.length - 1;

            for (let R = dataStartRow; R <= dataEndRow; ++R) {
                // Left border
                const leftCell = XLSX.utils.encode_cell({ r: R, c: 1 });
                if (ws[leftCell] && ws[leftCell].s && ws[leftCell].s.border) {
                    ws[leftCell].s.border.left = { style: 'medium', color: { rgb: '000000' } };
                }
                // Right border
                const rightCell = XLSX.utils.encode_cell({ r: R, c: dataEndCol });
                if (ws[rightCell] && ws[rightCell].s && ws[rightCell].s.border) {
                    ws[rightCell].s.border.right = { style: 'medium', color: { rgb: '000000' } };
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, periodLabel.substring(0, 31));

            const filename = `${t('timesheet')}_${periodLabel.replace(/\s+/g, '_')}.xlsx`;
            XLSX.writeFile(wb, filename);
            showStatus(t('excelExported'));
        }

        // Share
        function shareSheet() {
            const periodLabel = getPeriodLabel();
            const dates = getViewDates();
            let totalHours = 0;
            dates.forEach(date => {
                const entry = entries[formatDate(date)] || {};
                projects.forEach(p => totalHours += entry[p] || 0);
            });

            const shareData = {
                title: `TOM ${t('timesheet')}`,
                text: `${t('timesheet')}: ${periodLabel}\n${t('totalLabel')}: ${totalHours.toFixed(2)} h\n${t('byLabel')}: ${settings.userName || 'User'}`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData).catch(() => {
                    copyToClipboard(shareData.text);
                });
            } else {
                copyToClipboard(shareData.text);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus(t('copiedClipboard'));
            }).catch(() => {
                showStatus(t('couldNotShare'));
            });
        }

        // Email
        function emailSheet() {
            const periodLabel = getPeriodLabel();
            const dates = getViewDates();
            let totalHours = 0;
            let body = `${t('timesheet')}: ${periodLabel}\n\n`;

            dates.forEach(date => {
                const dateStr = formatDate(date);
                const entry = entries[dateStr] || {};
                let dayHours = 0;
                projects.forEach(p => dayHours += entry[p] || 0);
                if (dayHours > 0) {
                    body += `${formatDateDisplay(date)}: ${dayHours.toFixed(2)}h`;
                    if (entry.location && entry.location !== '-') body += ` (${entry.location})`;
                    if (entry.notes) body += ` - ${entry.notes}`;
                    body += '\n';
                }
                totalHours += dayHours;
            });

            body += `\n${t('totalLabel')}: ${totalHours.toFixed(2)} h`;
            body += `\n\n${t('projectBreakdown')}:\n`;
            projects.forEach(p => {
                let projectTotal = 0;
                dates.forEach(date => {
                    const entry = entries[formatDate(date)] || {};
                    projectTotal += entry[p] || 0;
                });
                if (projectTotal > 0) {
                    body += `- ${p}: ${projectTotal.toFixed(2)}h\n`;
                }
            });

            const subject = `${t('timesheet')} - ${periodLabel} - ${settings.userName || 'User'}`;
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }

        function printSheet() {
            window.print();
        }
    </script>
</body>
</html>
